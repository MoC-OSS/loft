{"version":3,"file":"Session.js","names":["ChatHistory","getLogger","l","Session","constructor","sessionStorage","sessionData","sessionId","systemMessageName","systemMessage","info","logPrefix","model","modelPreset","messages","examples","lastMessageByRole","handlersCount","ctx","messageAccumulator","createdAt","updatedAt","lastError","save","delete","deleteSession","toJSON"],"sources":["../../src/session/Session.ts"],"sourcesContent":["import { PalmExample, SessionProps } from './../@types';\nimport { SessionStorage } from './SessionStorage';\nimport { SystemMessageType } from '../schema/CreateChatCompletionRequestSchema';\nimport { ChatHistory } from './ChatHistory';\nimport { getLogger } from './../Logger';\nimport { Message } from './Message';\n\nconst l = getLogger('Session');\n\nexport class Session implements SessionProps {\n  readonly sessionId: string;\n  readonly systemMessageName: string;\n  readonly systemMessage: string;\n  readonly model: string;\n  readonly modelPreset: SystemMessageType['modelPreset'];\n  messages: ChatHistory;\n  readonly examples: PalmExample[];\n  lastMessageByRole: {\n    user: Message | null;\n    assistant: Message | null;\n  };\n  handlersCount: Record<string, number>;\n  public ctx: Record<string, unknown>;\n  messageAccumulator: Message[] | null;\n  readonly createdAt: number;\n  updatedAt: number;\n  lastError: string | null;\n\n  constructor(\n    private readonly sessionStorage: SessionStorage,\n    sessionData: SessionProps,\n  ) {\n    this.sessionId = sessionData.sessionId;\n    this.systemMessageName = sessionData.systemMessageName;\n    this.systemMessage = sessionData.systemMessage;\n\n    l.info(`${this.logPrefix()} Session initialization...`);\n\n    this.model = sessionData.model;\n    this.modelPreset = sessionData.modelPreset;\n    this.messages = new ChatHistory(\n      sessionData.sessionId,\n      sessionData.systemMessageName,\n      ...sessionData.messages,\n    );\n    this.examples = sessionData.examples;\n    this.lastMessageByRole = sessionData.lastMessageByRole;\n    this.handlersCount = sessionData.handlersCount;\n    this.ctx = sessionData.ctx;\n    this.messageAccumulator = sessionData.messageAccumulator || null;\n    this.createdAt = sessionData.createdAt;\n    this.updatedAt = sessionData.updatedAt;\n    this.lastError = sessionData.lastError;\n  }\n\n  private logPrefix(): string {\n    return `sessionId: ${this.sessionId}, systemMessageName: ${this.systemMessageName} -`;\n  }\n\n  public async save(): Promise<Session> {\n    l.info(`${this.logPrefix()} - save session`);\n    return this.sessionStorage.save(this);\n  }\n\n  public async delete(): Promise<void> {\n    l.info(`${this.logPrefix()} - delete session`);\n    this.sessionStorage.deleteSession(this.sessionId, this.systemMessageName);\n  }\n\n  public toJSON(): SessionProps {\n    return {\n      sessionId: this.sessionId,\n      systemMessageName: this.systemMessageName,\n      systemMessage: this.systemMessage,\n      model: this.model,\n      modelPreset: this.modelPreset,\n      messages: this.messages,\n      examples: this.examples,\n      lastMessageByRole: this.lastMessageByRole,\n      handlersCount: this.handlersCount,\n      ctx: this.ctx,\n      messageAccumulator: this.messageAccumulator,\n      createdAt: this.createdAt,\n      updatedAt: this.updatedAt,\n      lastError: this.lastError,\n    };\n  }\n}\n"],"mappings":"AAGA,OAASA,WAAW,KAAQ,eAAe,CAC3C,OAASC,SAAS,KAAQ,aAAa,CAGvC,KAAM,CAAAC,CAAC,CAAGD,SAAS,CAAC,SAAS,CAAC,CAE9B,MAAO,MAAM,CAAAE,OAAgC,CAmB3CC,WAAWA,CACQC,cAA8B,CAC/CC,WAAyB,CACzB,MAFiBD,cAA8B,CAA9BA,cAA8B,CAG/C,IAAI,CAACE,SAAS,CAAGD,WAAW,CAACC,SAAS,CACtC,IAAI,CAACC,iBAAiB,CAAGF,WAAW,CAACE,iBAAiB,CACtD,IAAI,CAACC,aAAa,CAAGH,WAAW,CAACG,aAAa,CAE9CP,CAAC,CAACQ,IAAI,CAAE,GAAE,IAAI,CAACC,SAAS,CAAC,CAAE,4BAA2B,CAAC,CAEvD,IAAI,CAACC,KAAK,CAAGN,WAAW,CAACM,KAAK,CAC9B,IAAI,CAACC,WAAW,CAAGP,WAAW,CAACO,WAAW,CAC1C,IAAI,CAACC,QAAQ,CAAG,GAAI,CAAAd,WAAW,CAC7BM,WAAW,CAACC,SAAS,CACrBD,WAAW,CAACE,iBAAiB,CAC7B,GAAGF,WAAW,CAACQ,QACjB,CAAC,CACD,IAAI,CAACC,QAAQ,CAAGT,WAAW,CAACS,QAAQ,CACpC,IAAI,CAACC,iBAAiB,CAAGV,WAAW,CAACU,iBAAiB,CACtD,IAAI,CAACC,aAAa,CAAGX,WAAW,CAACW,aAAa,CAC9C,IAAI,CAACC,GAAG,CAAGZ,WAAW,CAACY,GAAG,CAC1B,IAAI,CAACC,kBAAkB,CAAGb,WAAW,CAACa,kBAAkB,EAAI,IAAI,CAChE,IAAI,CAACC,SAAS,CAAGd,WAAW,CAACc,SAAS,CACtC,IAAI,CAACC,SAAS,CAAGf,WAAW,CAACe,SAAS,CACtC,IAAI,CAACC,SAAS,CAAGhB,WAAW,CAACgB,SAC/B,CAEQX,SAASA,CAAA,CAAW,CAC1B,MAAQ,cAAa,IAAI,CAACJ,SAAU,wBAAuB,IAAI,CAACC,iBAAkB,IACpF,CAEA,KAAa,CAAAe,IAAIA,CAAA,CAAqB,CACpCrB,CAAC,CAACQ,IAAI,CAAE,GAAE,IAAI,CAACC,SAAS,CAAC,CAAE,iBAAgB,CAAC,CAC5C,MAAO,KAAI,CAACN,cAAc,CAACkB,IAAI,CAAC,IAAI,CACtC,CAEA,KAAa,CAAAC,MAAMA,CAAA,CAAkB,CACnCtB,CAAC,CAACQ,IAAI,CAAE,GAAE,IAAI,CAACC,SAAS,CAAC,CAAE,mBAAkB,CAAC,CAC9C,IAAI,CAACN,cAAc,CAACoB,aAAa,CAAC,IAAI,CAAClB,SAAS,CAAE,IAAI,CAACC,iBAAiB,CAC1E,CAEOkB,MAAMA,CAAA,CAAiB,CAC5B,MAAO,CACLnB,SAAS,CAAE,IAAI,CAACA,SAAS,CACzBC,iBAAiB,CAAE,IAAI,CAACA,iBAAiB,CACzCC,aAAa,CAAE,IAAI,CAACA,aAAa,CACjCG,KAAK,CAAE,IAAI,CAACA,KAAK,CACjBC,WAAW,CAAE,IAAI,CAACA,WAAW,CAC7BC,QAAQ,CAAE,IAAI,CAACA,QAAQ,CACvBC,QAAQ,CAAE,IAAI,CAACA,QAAQ,CACvBC,iBAAiB,CAAE,IAAI,CAACA,iBAAiB,CACzCC,aAAa,CAAE,IAAI,CAACA,aAAa,CACjCC,GAAG,CAAE,IAAI,CAACA,GAAG,CACbC,kBAAkB,CAAE,IAAI,CAACA,kBAAkB,CAC3CC,SAAS,CAAE,IAAI,CAACA,SAAS,CACzBC,SAAS,CAAE,IAAI,CAACA,SAAS,CACzBC,SAAS,CAAE,IAAI,CAACA,SAClB,CACF,CACF"}