{"version":3,"file":"CloudStorageService.js","names":["Storage","createChatCompletionRequestSchema","PromptSchema","getLogger","l","CloudStorageService","constructor","env","bucketName","appName","info","storage","getFile","filename","file","bucket","data","download","err","getSystemMessages","fileName","errorMessage","error","logToGCP","process","exit","systemMessages","JSON","parse","toString","getPrompts","prompts","save","catch"],"sources":["../../../src/memory/gcp/CloudStorageService.ts"],"sourcesContent":["import { Storage } from '@google-cloud/storage';\nimport {\n  CreateChatCompletionRequestType,\n  createChatCompletionRequestSchema,\n} from './../../schema/CreateChatCompletionRequestSchema';\nimport { PromptSchema, PromptsFileType } from './../../schema/PromptSchema';\nimport { getLogger } from './../../Logger';\nimport { IStorageService } from '../CloudObjectStorage';\n\nconst l = getLogger('GCPStorageService');\n\nexport class CloudStorageService implements IStorageService {\n  private readonly storage: Storage;\n\n  constructor(\n    private readonly env: string,\n    private readonly bucketName: string,\n    private readonly appName: string,\n  ) {\n    l.info('GCPStorageService initialization...');\n    this.storage = new Storage({});\n    l.info(`Configured Google Cloud Storage.`);\n  }\n\n  async getFile(filename: string): Promise<Buffer | null> {\n    try {\n      l.info(`getting file: ${filename} from GCP Storage...`);\n      const file = this.storage.bucket(this.bucketName).file(filename);\n      const [data] = await file.download();\n      return data;\n    } catch (err) {\n      // if (err.code === 404) {\n      //   l.warn(`File ${filename} not found!`);\n      //   return null;\n      // }\n      throw err;\n    }\n  }\n\n  async getSystemMessages(): Promise<CreateChatCompletionRequestType> {\n    try {\n      l.info('getting systemMessages from GCP Storage...');\n      const fileName = `${this.appName}/${this.env}/system_messages.json`;\n      const file = await this.getFile(fileName);\n\n      if (file === null) {\n        const errorMessage = `File ${fileName} not found!`;\n        l.error(errorMessage, 'App will be terminated.');\n        await this.logToGCP(errorMessage);\n        process.exit(1);\n      }\n\n      l.info('parsing systemMessages...');\n      const systemMessages = JSON.parse(file.toString());\n      l.info('validating systemMessages...');\n      return createChatCompletionRequestSchema.parse(systemMessages);\n    } catch (error) {\n      l.error(error);\n      await this.logToGCP((error as Error).toString());\n      throw error;\n    }\n  }\n\n  async getPrompts(): Promise<PromptsFileType> {\n    try {\n      l.info('getting prompts from GCP Storage...');\n      const fileName = `${this.appName}/${this.env}/prompts.json`;\n      const file = await this.getFile(fileName);\n\n      if (file === null) {\n        const errorMessage = `File ${fileName} not found!`;\n        l.error(errorMessage, 'App will be terminated.');\n        await this.logToGCP(errorMessage);\n        process.exit(1);\n      }\n\n      l.info('parsing prompts...');\n      const prompts = JSON.parse(file.toString());\n      l.info('validating prompts...');\n      return PromptSchema.parse(prompts);\n    } catch (error) {\n      l.error(error);\n      await this.logToGCP((error as Error).toString());\n      throw error;\n    }\n  }\n\n  async logToGCP(data: string) {\n    l.info('logging error to GCP Storage...');\n    const file = this.storage\n      .bucket(this.bucketName)\n      .file(`${this.appName}/${this.env}/log_errors.txt`);\n    await file.save(data).catch((err) => l.error(err));\n  }\n}\n"],"mappings":"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"}